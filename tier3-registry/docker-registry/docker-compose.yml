version: '3.8'

services:
  # Docker Registry
  foundation-tier3-registry:
    image: ${REGISTRY_IMAGE:-registry:2}
    container_name: foundation-tier3-registry
    restart: unless-stopped
    networks:
      - foundation-layer-network
    ports:
      - "${REGISTRY_PORT:-5000}:5000"
    environment:
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
      REGISTRY_HTTP_ADDR: 0.0.0.0:5000
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    volumes:
      # Data in /docker-storage (read-write)
      - ${DOCKER_STORAGE_ROOT:-/docker-storage}/foundation/docker-registry/data/:/var/lib/registry/:rw
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/v2/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "tier=3"
      - "component=registry"
      - "portfolio=${PORTFOLIO_NAME:-portfolio-bunyan}"
      - "layer=${LAYER_NAME:-foundation-layer}"
      - "project=${PROJECT_NAME:-stream-foundation}"
      - "network=${NETWORK_NAME:-foundation-layer-network}"
      - "traefik.enable=true"
      - "traefik.docker.network=foundation-layer-network"
      - "traefik.http.routers.registry.rule=Host(`registry.local`)"
      - "traefik.http.routers.registry.service=registry"
      - "traefik.http.services.registry.loadbalancer.server.port=5000"
      - "traefik.http.routers.registry.middlewares=keycloak-forward-auth"
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=5000"

networks:
  foundation-layer-network:
    name: foundation-layer-network
    external: true
