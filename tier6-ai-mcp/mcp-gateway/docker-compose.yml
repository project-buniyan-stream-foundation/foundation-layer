version: '3.8'

services:
  # MCP Gateway - AI Tool Integration
  foundation-mcp-gateway:
    image: ${MCP_GATEWAY_IMAGE:-docker/mcp-gateway:latest}
    container_name: foundation-mcp-gateway
    restart: unless-stopped
    networks:
      - foundation-layer-network
    ports:
      - "${MCP_GATEWAY_PORT:-8811}:8811"
    volumes:
      # Docker socket for Docker MCP server
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Configuration from codebase (read-only)
      - ./config/mcp-gateway-config.yaml:/root/.docker/mcp/config.yaml:ro
      # Data in /docker-storage (read-write)
      - ${DOCKER_STORAGE_ROOT:-/docker-storage}/foundation/mcp-gateway/data/:/data/:rw
    environment:
      DOCKER_MCP_USE_CE: ${DOCKER_MCP_USE_CE:-true}
      DOCKER_MCP_IN_CONTAINER: 1
    entrypoint: ["/docker-mcp", "gateway", "run"]
    command:
      - --transport=sse
      - --port=8811
      - --watch=true
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8811/health || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "tier=6"
      - "component=ai-mcp"
      - "portfolio=${PORTFOLIO_NAME:-portfolio-bunyan}"
      - "layer=${LAYER_NAME:-foundation-layer}"
      - "project=${PROJECT_NAME:-stream-foundation}"
      - "network=${NETWORK_NAME:-foundation-layer-network}"
      - "traefik.enable=true"
      - "traefik.docker.network=foundation-layer-network"
      - "traefik.http.routers.mcp.rule=Host(`mcp.local`)"
      - "traefik.http.routers.mcp.service=mcp-gateway"
      - "traefik.http.services.mcp-gateway.loadbalancer.server.port=8811"
      - "traefik.http.routers.mcp.middlewares=keycloak-forward-auth"
      - "prometheus.io/scrape=true"
      - "prometheus.io/port=8811"
      - "prometheus.io/path=/metrics"

networks:
  foundation-layer-network:
    name: foundation-layer-network
    external: true
